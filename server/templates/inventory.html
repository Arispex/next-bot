<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>用户背包</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: "#eff6ff",
              100: "#dbeafe",
              500: "#3b82f6",
              600: "#2563eb",
              700: "#1d4ed8",
              800: "#1e40af"
            }
          }
        }
      }
    };
  </script>
</head>
<body class="min-h-screen bg-[radial-gradient(circle_at_top,#dbeafe_0%,#f8fafc_35%,#e2e8f0_100%)] p-5 text-slate-900">
  <main class="mx-auto max-w-[2100px] overflow-hidden rounded-3xl border border-slate-200 bg-white/90 shadow-2xl shadow-blue-200/60 backdrop-blur">
    <header class="relative overflow-hidden bg-gradient-to-r from-brand-700 via-brand-600 to-brand-800 px-6 py-5 text-white">
      <div class="absolute -left-10 -top-12 h-40 w-40 rounded-full bg-white/15 blur-2xl"></div>
      <div class="absolute -right-16 top-0 h-44 w-44 rounded-full bg-cyan-200/20 blur-3xl"></div>
      <div class="relative">
        <h1 class="text-3xl font-bold tracking-wide">用户背包</h1>
        <div class="mt-4 space-y-2 text-sm">
          <div class="grid grid-cols-2 gap-2 md:grid-cols-5">
            <div class="rounded-lg bg-white/15 px-3 py-2">
              <div class="text-[11px] text-blue-100">用户 ID</div>
              <div id="meta-user-id" class="truncate font-semibold"></div>
            </div>
            <div class="rounded-lg bg-white/15 px-3 py-2">
              <div class="text-[11px] text-blue-100">用户名称</div>
              <div id="meta-user-name" class="truncate font-semibold"></div>
            </div>
            <div class="rounded-lg bg-white/15 px-3 py-2">
              <div class="text-[11px] text-blue-100">服务器 ID</div>
              <div id="meta-server-id" class="truncate font-semibold"></div>
            </div>
            <div class="rounded-lg bg-white/15 px-3 py-2">
              <div class="text-[11px] text-blue-100">服务器名称</div>
              <div id="meta-server-name" class="truncate font-semibold"></div>
            </div>
            <div class="rounded-lg bg-white/15 px-3 py-2">
              <div class="text-[11px] text-blue-100">生成时间</div>
              <div id="meta-generated-at" class="truncate font-semibold"></div>
            </div>
          </div>
          <div class="grid grid-cols-1 gap-2 md:grid-cols-3">
            <div class="rounded-lg bg-white/15 px-3 py-2">
              <div class="text-[11px] text-blue-100">生命值</div>
              <div id="meta-life" class="truncate font-semibold"></div>
            </div>
            <div class="rounded-lg bg-white/15 px-3 py-2">
              <div class="text-[11px] text-blue-100">魔力值</div>
              <div id="meta-mana" class="truncate font-semibold"></div>
            </div>
            <div class="rounded-lg bg-white/15 px-3 py-2">
              <div class="text-[11px] text-blue-100">渔夫任务数</div>
              <div id="meta-fishing-tasks" class="truncate font-semibold"></div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <section class="border-b border-slate-200 bg-gradient-to-r from-brand-50 to-slate-50 px-5 py-3 text-sm text-slate-700">
      <div class="flex flex-wrap items-center gap-3">
        <span class="rounded-full border border-brand-200 bg-white px-3 py-1">显示格数：<b id="meta-total">0</b></span>
        <span class="rounded-full border border-emerald-200 bg-white px-3 py-1">已占用：<b id="meta-used">0</b></span>
        <span class="rounded-full border border-slate-200 bg-white px-3 py-1">空格：<b id="meta-empty">0</b></span>
      </div>
    </section>
    <section class="p-4">
      <div id="section-rows" class="space-y-4"></div>
    </section>
    <div class="px-6 pb-4 text-right text-xs font-medium tracking-wide text-slate-400">
      Powered by Next Bot
    </div>
  </main>

  <script id="inventory-data" type="application/json">__INVENTORY_DATA_JSON__</script>
  <script>
    const data = JSON.parse(document.getElementById("inventory-data").textContent);
    document.getElementById("meta-user-id").textContent = data.user_id || "";
    document.getElementById("meta-user-name").textContent = data.user_name || "";
    document.getElementById("meta-server-id").textContent = data.server_id || "";
    document.getElementById("meta-server-name").textContent = data.server_name || "";
    document.getElementById("meta-generated-at").textContent = data.generated_at || "";
    document.getElementById("meta-life").textContent = data.life_text || "";
    document.getElementById("meta-mana").textContent = data.mana_text || "";
    document.getElementById("meta-fishing-tasks").textContent = data.fishing_tasks_text || "";

    const slots = Array.isArray(data.slots) ? data.slots : [];
    const sectionRows = document.getElementById("section-rows");
    const itemNameMap = new Map();
    const prefixNameMap = new Map();
    let activeHintEl = null;

    async function loadNameDicts() {
      try {
        const [itemRes, prefixRes] = await Promise.all([
          fetch("/assets/dicts/item.json"),
          fetch("/assets/dicts/prefix.json")
        ]);
        if (itemRes.ok) {
          const itemList = await itemRes.json();
          if (Array.isArray(itemList)) {
            itemList.forEach((entry) => {
              const id = Number(entry?.id);
              const name = String(entry?.name || "").trim();
              if (id > 0 && name) {
                itemNameMap.set(id, name);
              }
            });
          }
        }
        if (prefixRes.ok) {
          const prefixList = await prefixRes.json();
          if (Array.isArray(prefixList)) {
            prefixList.forEach((entry) => {
              const id = Number(entry?.id);
              const name = String(entry?.name || "").trim();
              if (id > 0 && name) {
                prefixNameMap.set(id, name);
              }
            });
          }
        }
      } catch (_) {
        // 字典加载失败时回退为显示 ID，不阻塞页面渲染
      }
    }

    function range(start, end) {
      const out = [];
      for (let i = start; i <= end; i += 1) out.push(i);
      return out;
    }

    const sections = [
      { id: "main", title: "主背包", indices: range(0, 49), cols: 10 },
      { id: "ammo_1", title: "货币", indices: range(50, 53), cols: 1 },
      { id: "ammo_2", title: "弹药", indices: range(54, 57), cols: 1 },
      { id: "loadout_1", title: "第一套装备/饰品/染料", indices: range(59, 88), cols: 3 },
      { id: "misc_equip", title: "饰品", indices: range(89, 93), cols: 1 },
      { id: "misc_dye", title: "染料", indices: range(94, 98), cols: 1 },
      { id: "piggy", title: "猪猪存钱罐", indices: range(99, 138), cols: 10 },
      { id: "safe", title: "保险箱", indices: range(139, 178), cols: 10 },
      { id: "trash", title: "垃圾桶", indices: [179], cols: 1 },
      { id: "forge", title: "护卫熔炉", indices: range(180, 219), cols: 10 },
      { id: "void", title: "虚空袋", indices: range(220, 259), cols: 10 },
      { id: "loadout_2", title: "第二套装备/饰品/染料", indices: range(290, 319), cols: 3 },
      { id: "loadout_3", title: "第三套装备/饰品/染料", indices: range(320, 349), cols: 3 }
    ];
    const sectionById = Object.fromEntries(sections.map((section) => [section.id, section]));
    const sectionRowsConfig = [
      ["main", "piggy", "safe"],
      ["loadout_1", "loadout_2", "loadout_3", "misc_equip_stack", "misc_dye", "ammo_1", "ammo_2", "forge_stack"]
    ];

    function getSlot(index) {
      const raw = slots[index];
      const netId = Number(raw?.net_id || 0);
      const prefixId = Number(raw?.prefix_id || raw?.prefix || 0);
      const stack = Number(raw?.stack || 0);
      return {
        index,
        netId: netId > 0 ? netId : 0,
        prefixId: prefixId > 0 ? prefixId : 0,
        stack: stack > 0 ? stack : 0
      };
    }

    function clearActiveHint() {
      if (activeHintEl) {
        activeHintEl.remove();
        activeHintEl = null;
      }
    }

    function buildItemHint(slot) {
      if (slot.netId <= 0) return "";
      const itemName = itemNameMap.get(slot.netId) || `物品ID:${slot.netId}`;
      const prefixName = slot.prefixId > 0 ? (prefixNameMap.get(slot.prefixId) || `前缀ID:${slot.prefixId}`) : "";
      return prefixName ? `${prefixName} ${itemName}` : itemName;
    }

    function createCell(slot) {
      const cell = document.createElement("div");
      cell.className = "group relative h-[52px] w-[52px] rounded-lg border border-slate-300 bg-gradient-to-b from-brand-50 to-slate-100 shadow-sm";

      if (slot.netId <= 0) {
        cell.classList.remove("from-brand-50", "to-slate-100");
        cell.classList.add("bg-slate-100");
      }

      const idx = document.createElement("span");
      idx.className = "absolute left-1 top-0.5 z-10 text-[9px] font-medium text-slate-500";
      idx.textContent = String(slot.index);
      cell.appendChild(idx);

      if (slot.netId > 0) {
        const img = document.createElement("img");
        img.className = "h-full w-full object-contain p-1.5 transition-transform duration-150 group-hover:scale-110";
        img.style.imageRendering = "pixelated";
        img.src = `/assets/items/Item_${slot.netId}.png`;
        img.alt = `Item ${slot.netId}`;
        img.loading = "lazy";
        cell.appendChild(img);
      }

      if (slot.stack > 1) {
        const stackTag = document.createElement("span");
        stackTag.className = "absolute bottom-0.5 right-0.5 rounded-md border border-white/20 bg-slate-900/80 px-1 text-[10px] font-bold text-white";
        stackTag.textContent = String(slot.stack);
        cell.appendChild(stackTag);
      }

      cell.addEventListener("click", (event) => {
        event.stopPropagation();
        clearActiveHint();
        const hintText = buildItemHint(slot);
        if (!hintText) return;
        const hint = document.createElement("span");
        hint.className = "pointer-events-none absolute left-1/2 top-0 z-20 -translate-x-1/2 -translate-y-full whitespace-nowrap rounded-md border border-slate-200 bg-slate-900/95 px-2 py-1 text-[11px] font-medium text-white shadow-md";
        hint.textContent = hintText;
        cell.appendChild(hint);
        activeHintEl = hint;
      });

      return cell;
    }

    function createSectionCard(section) {
      const sectionSlots = section.indices.map(getSlot);
      const used = sectionSlots.filter((slot) => slot.netId > 0).length;

      const card = document.createElement("article");
      card.className = "inline-block w-fit overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm";

      const head = document.createElement("header");
      head.className = "flex items-center justify-between border-b border-slate-200 bg-slate-50 px-4 py-3";

      const titleWrap = document.createElement("div");
      const title = document.createElement("h2");
      title.className = "text-base font-semibold text-slate-900";
      title.textContent = section.title;
      titleWrap.appendChild(title);

      const badge = document.createElement("span");
      badge.className = "rounded-full border border-brand-200 bg-brand-50 px-2.5 py-1 text-xs font-semibold text-brand-700";
      badge.textContent = `${used}/${sectionSlots.length}`;

      head.appendChild(titleWrap);
      head.appendChild(badge);

      const body = document.createElement("div");
      body.className = "overflow-x-auto p-4";

      const grid = document.createElement("div");
      grid.className = "grid gap-2";
      grid.style.gridTemplateColumns = `repeat(${section.cols}, 52px)`;
      grid.style.minWidth = `${section.cols * 52 + Math.max(section.cols - 1, 0) * 8}px`;

      sectionSlots.forEach((slot) => grid.appendChild(createCell(slot)));
      body.appendChild(grid);

      card.appendChild(head);
      card.appendChild(body);
      return { card, used, total: sectionSlots.length };
    }

    async function init() {
      await loadNameDicts();

      let usedTotal = 0;
      let total = 0;
      sectionRowsConfig.forEach((rowIds) => {
        const row = document.createElement("div");
        row.className = "overflow-x-auto";
        const rowInner = document.createElement("div");
        rowInner.className = "mx-auto flex w-max items-start gap-4 px-2";
        rowIds.forEach((id) => {
          if (id === "forge_stack") {
            const stackWrap = document.createElement("div");
            stackWrap.className = "flex flex-col gap-4";
            const forgeCard = createSectionCard(sectionById.forge);
            const voidCard = createSectionCard(sectionById.void);
            stackWrap.appendChild(forgeCard.card);
            stackWrap.appendChild(voidCard.card);
            rowInner.appendChild(stackWrap);
            usedTotal += forgeCard.used + voidCard.used;
            total += forgeCard.total + voidCard.total;
            return;
          }
          if (id === "misc_equip_stack") {
            const stackWrap = document.createElement("div");
            stackWrap.className = "flex flex-col gap-4";
            const miscEquipCard = createSectionCard(sectionById.misc_equip);
            const trashCard = createSectionCard(sectionById.trash);
            stackWrap.appendChild(miscEquipCard.card);
            stackWrap.appendChild(trashCard.card);
            rowInner.appendChild(stackWrap);
            usedTotal += miscEquipCard.used + trashCard.used;
            total += miscEquipCard.total + trashCard.total;
            return;
          }
          const section = sectionById[id];
          if (!section) return;
          const { card, used, total: sectionTotal } = createSectionCard(section);
          rowInner.appendChild(card);
          usedTotal += used;
          total += sectionTotal;
        });
        row.appendChild(rowInner);
        sectionRows.appendChild(row);
      });

      document.getElementById("meta-total").textContent = String(total);
      document.getElementById("meta-used").textContent = String(usedTotal);
      document.getElementById("meta-empty").textContent = String(Math.max(0, total - usedTotal));
    }

    document.addEventListener("click", clearActiveHint);
    init();
  </script>
</body>
</html>
